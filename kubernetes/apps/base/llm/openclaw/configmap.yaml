apiVersion: v1
kind: ConfigMap
metadata:
  github-webhook-transform.js: |
    // GitHub Webhook Transform for OpenClaw
    const { spawn } = require('child_process');

    // Import the existing GitHub App token manager
    const { getTokenManager } = require('./github-app-token-manager.js');

    // Import the grumpy-sysadmin agent to execute review directly
    const { processPRReview } = require('./grumpy-sysadmin-agent.js');

    /**
     * Transform function for GitHub webhook events
     * @param {Object} ctx - Context object containing payload, headers, etc.
     * @returns {Object} Response object
     */
    async function transform(ctx) {
      const event = ctx.payload;
      console.log('Received GitHub webhook event:', event.action || 'unknown');

      const eventType = ctx.headers['x-github-event'];
      const deliveryId = ctx.headers['x-github-delivery'];

      console.log(`Processing ${eventType} event with delivery ID: ${deliveryId}`);

      if (eventType === 'pull_request' && event.action === 'opened') {
        // GitHub webhook payload structure has the PR data in 'pull_request' field
        const pullRequest = event.pull_request || event;

        // Extract PR information using proper GitHub webhook payload structure
        const prInfo = {
          repo: event.repository?.full_name || `${event.organization?.login}/${event.repository?.name}`,
          pr_number: pullRequest?.number || event.number,
          title: pullRequest?.title,
          description: pullRequest?.body || pullRequest?.description || '',
          author: pullRequest?.user?.login || event.sender?.login || 'unknown',
          url: pullRequest?.html_url,
          created_at: pullRequest?.created_at || pullRequest?.created_at
        };

        console.log(`New PR #${prInfo.pr_number} opened: ${prInfo.title}`);

        // Validate that we have the required information
        if (!prInfo.repo || !prInfo.pr_number) {
          console.error('Missing required PR information:', prInfo);
          console.error('Full event object:', JSON.stringify(event, null, 2));
          return {
            message: `Error: Missing required PR information. Repo: ${prInfo.repo}, PR Number: ${prInfo.pr_number}`,
            channel: "last"
          };
        }

        try {
          // Execute the PR review directly instead of spawning an agent
          const reviewResult = await processPRReview(
            { repo: prInfo.repo, pr_number: prInfo.pr_number },
            { pr_info: prInfo }
          );

          console.log('PR review completed:', reviewResult);

          return {
            message: `Grumpy sysadmin review completed for PR #${prInfo.pr_number}`,
            channel: "last"
          };
        } catch (error) {
          console.error('Error during PR review:', error.message);
          return {
            message: `Error during PR review: ${error.message}`,
            channel: "last"
          };
        }
      }
      else if (eventType === 'pull_request' && event.action === 'synchronize') {
        // Handle PR updates (new commits pushed)
        const pullRequest = event.pull_request || event;
        
        const prInfo = {
          repo: event.repository?.full_name || `${event.organization?.login}/${event.repository?.name}`,
          pr_number: pullRequest?.number || event.number,
          title: pullRequest?.title,
          description: pullRequest?.body || pullRequest?.description || '',
          author: pullRequest?.user?.login || event.sender?.login || 'unknown',
          url: pullRequest?.html_url,
          created_at: pullRequest?.created_at || pullRequest?.created_at
        };

        console.log(`PR #${prInfo.pr_number} synchronized (updated): ${prInfo.title}`);

        // Validate that we have the required information
        if (!prInfo.repo || !prInfo.pr_number) {
          console.error('Missing required PR information for sync event:', prInfo);
          return {
            message: `Error: Missing required PR information for sync. Repo: ${prInfo.repo}, PR Number: ${prInfo.pr_number}`,
            channel: "last"
          };
        }

        try {
          // Execute the PR review directly for sync events too
          const reviewResult = await processPRReview(
            { repo: prInfo.repo, pr_number: prInfo.pr_number },
            { pr_info: prInfo }
          );

          console.log('PR resync review completed:', reviewResult);

          return {
            message: `Grumpy sysadmin review completed for PR #${prInfo.pr_number} resync`,
            channel: "last"
          };
        } catch (error) {
          console.error('Error during PR resync review:', error.message);
          return {
            message: `Error during PR resync review: ${error.message}`,
            channel: "last"
          };
        }
      }
      else if (eventType === 'pull_request' && ['closed', 'merged'].includes(event.action)) {
        const pullRequest = event.pull_request || event;
        const action = event.action === 'merged' ? 'merged' : 'closed';

        console.log(`PR #${pullRequest?.number} ${action}: ${pullRequest?.title}`);

        return {
          message: `Pull request #${event.repository?.full_name}/${pullRequest?.number} was ${action}`,
          channel: "last"
        };
      }
      else {
        // For other events, return a simple acknowledgment
        return {
          message: `Received ${eventType} event: ${event.action || 'unknown'}`,
          channel: "last"
        };
      }
    }

    module.exports = transform;
null