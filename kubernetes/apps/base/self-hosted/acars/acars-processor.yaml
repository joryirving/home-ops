# yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/main/schema.json

ACARSProcessorSettings:
  ColorOutput: true
  LogLevel: debug
  LogHideTimestamps: true
  Database:
    Enabled: true
    Type: sqlite
    SQLiteDatabasePath: /data/messages.db
  ACARSHub:
    MaxConcurrentRequests: 1
    ACARS:
      Host: &acarshubhost acars-hub
      Port: 15550
    # VDLM2:
    #   Host: *acarshubhost
    #   Port: 15555

Steps:
  - Filter: { Builtin: { HasText: true } }

  # The decoders often submit duplicate messages as they're able to reassemble
  # the messages
  - Filter:
      Builtin:
        PreviousMessageSimilarity:
          Similarity: 0.90
          MaximumLookBehind: 1000
          DontFilterIfLonger: false

  # These labels have not had a human-written message in the last 30 days
  - Filter:
      Builtin:
        Invert: true
        Labels:
          - "_d"
          - ""
          - ":;"
          - "12"
          - "16"
          - "21"
          - "22"
          - "32"
          - "33"
          - "36"
          - "43" # PAX REOPENED
          - "44"
          - "4N"
          - "5V"
          - "A9"
          - "B9"
          - "BA"
          - "C1"
          - "H1"
          - "Q0"
          - "SA"
          - "SQ"

  # These terms are present in routine messages that can be filtered
  - Filter:
      Builtin:
        Invert: true
        RequireTerms:
          Count: 1
          Terms:
            - /FTMLDR
            - RESREQ
            - POSRPT
            - AUTOMATED FLT OPS
            - UNFCTRD
            - USADCXA
            - "#DFREQ"
            - ET EXP TIME
            - AGFSR
            - PRG/
            - APU START <
            - "<"
            - ">"
            - +++
            - TAKEOFF_
            - .CSV
            - ------------
            # Airport DISP messages
            - ATIS INFO
            - TAXI AND SHUTDOWN THE APU
            - YOUR HELP IS APPRECIATED.
            - ADVS YOU
            - YOU HAVE INFO
            - BIRDS IN THE VICINITY
            - BIRD ACTIVITY
            - READBACK ALL
            - NOTICE TO AIRMEN
            - ALL GATES UNDER
            - S-E TAXI
            ###################
            - CODE BLEED STATUS
            - PREFLIGHT BRIEF
            - MDC REPORT
            - EXCEEDANCE REPORT
            - SNAPSHOT REPORT
            - SYSTEM PARAMETERS
            - ENGINE TREND
            - "CAROUSEL:"
            - FILENAME
            - CREW CONNECTING GATE INFO
            - MUST LAND ON RWY
            - REQUEST GATE ASSIGNMENT ETA
            - Equation ID

  # Have local Ollama model look only for human-written messages
  - Filter:
      Ollama:
        Model: &ollamamodel qwen3:8b
        URL: &ollamaurl https://ollama.jory.dev
        FilterOnFailure: true
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: &ollamaopts [
            { Name: num_predict, Value: 150 }, # Maximum number of tokens (words, kinda) to generate
            { Name: temperature, Value: 0.4 }, # Creativity (0.0-2.0)
            { Name: top_p, Value: 0.2 }, # Answer diversity with top_k (0.0-1.0)
            { Name: top_k, Value: 20 }, # Answer diversity (ex 0-100)
            { Name: frequency_penalty, Value: 1.1 }, # Penalize repeated tokens (0-2.0)
            { Name: num_gpu, Value: 40 }, # Number of layers to offload to GPU
          ]
        # -----------------------------------------
        # 955 characters
        # 283 tokens https://token-calculator.net
        # -----------------------------------------
        UserPrompt: |
          This message is either completely automatically generated or features
          a human-written message after some data. You must find the messages
          that have some human content.

          Human content in these messages might have misspellings, abbreviations
          or typos similar to cell phone text messages and may only be a few
          words. Human content will often have acronyms.

          DO forward if the message matches ANY of these criteria:
          - Contains any amount of natural or colloquial language or prose.
          - Contains a complaint, request or command.
          - Contains a greeting/sign-offs or their variations, for example: HI,
            HELLO, BONJOUR, GOOD MORNING/EVENING, THANK YOU/THANKS/THNKS/THX,
            BRGRDS/RGRDS, CHEERS, COPY/COPY THAT.
          - Has any prose content after the term FREETEXT or /TXT
          - Has /Q/ or QQ or QUESTION MARK which signifies a person is asking a
            question in this context.
          - Commentary or questions about aircraft passengers,crew,med,medical,
            medlink,booking,lavatories (abbreviation: LAV), seats, or other
            situations or events relating to air travel.
          - Lists a desk number or has DISPATCHER MSG.

          Based on these rules, should this message be forwarded?

  # This should be a human message, so send to my private Discord channel, with
  # fancy templating.
  - Send:
      Discord:
        Embed: true
        EmbedColorFacetFields: [ACARSProcessor.From]
        # EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${DISCORD_WEBHOOK_URL}"
        FormatText: true
        FormatTimestamps: true
        MessageGoTemplate: |
          -# From [{{index . "ACARSProcessor.TailCode"}}]({{index . "ACARSProcessor.TrackingLink"}}){{if ne "" (index . "ACARSProcessor.FlightNumber")}} on flight {{index . "ACARSProcessor.FlightNumber"}}{{else}}{{end}} <t:{{index . "ACARSProcessor.UnixTimestamp"}}:R>{{if ne 0.0 (index . "ACARSProcessor.AircraftDistanceMi")}}.
          ```
          {{index . "ACARSProcessor.MessageText"}}
          ```
          **Links**:
          [Translate this message]({{index . "ACARSProcessor.TranslateLink"}})
          [ACARSDrama messages from this aircraft]({{index . "ACARSProcessor.ACARSDramaTailNumberLink"}})
          [Aircraft Photos]({{index . "ACARSProcessor.PhotosLink"}})

  # Use Ollama again to evaluate the emotion of the message and filter in one
  # step
  - Annotate:
      Ollama:
        Model: *ollamamodel
        URL: *ollamaurl
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: *ollamaopts
        UserPrompt: |
          Rate the prose from found in this message from pilots and ATC between
          1-100 for any emotions such as anger, frustration, elation
          complaining, gratitude, confusion, etc.

          - 1-40 should indicate the message reads as neutral.
          - 40-80 should indicate the message is emotional in some way.
          - 80-100 should indicate the message is very emotional.
    Filter: { Builtin: { LLMProcessedNumberAbove: 40 } }

  # Send emotional messages to a different Discord channel
  - Send:
      Discord:
        Embed: true
        # EmbedColorFacetFields: [ACARSProcessor.From]
        EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${DISCORD_ANGER_WEBHOOK_URL}"
        # FormatText: true
        # FormatTimestamps: true
        MessageGoTemplate: |
          {{if eq (index . "ACARSProcessor.From") "Aircraft"}}From{{else}}To{{end}} [{{index . "ACARSProcessor.TailCode"}}]({{index . "ACARSProcessor.TrackingLink"}}){{if ne "" (index . "ACARSProcessor.FlightNumber")}} on flight {{index . "ACARSProcessor.FlightNumber"}}{{else}}{{end}} <t:{{index . "ACARSProcessor.UnixTimestamp"}}:R>{{if ne 0.0 (index . "ACARSProcessor.AircraftDistanceMi")}} from {{printf "%.2f" (index . "ACARSProcessor.AircraftDistanceMi")}} miles away{{else}}{{end}}.
          -# This message rated a {{index . "ACARSProcessor.LLMProcessedNumber"}} in terms of emotional content.

          ```
          {{index . "ACARSProcessor.MessageText"}}
          ```
          The LLM had this to say:
          ```
          {{index . "ACARSProcessor.LLMModelFeedbackText"}}
          ```

          **Links**:
          [Translate this message]({{index . "ACARSProcessor.TranslateLink"}})
          [ACARSDrama messages from this aircraft]({{index . "ACARSProcessor.ACARSDramaTailNumberLink"}})
          [Aircraft Photos]({{index . "ACARSProcessor.PhotosLink"}})
