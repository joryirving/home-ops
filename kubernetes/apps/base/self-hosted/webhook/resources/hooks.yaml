---
- id: github-joryirving-renovate
  execute-command: /config/renovate-operator.sh
  pass-arguments-to-command:
    - # job name
      source: string
      name: joryirving
    - # namespace
      source: string
      name: renovate
    - # project
      source: payload
      name: repository.full_name
    - # Renovate Operator webhook URL
      source: string
      name: http://renovate-operator.renovate.svc.cluster.local:8082
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger only for the joryirving repo owner
        match:
          type: value
          value: joryirving
          parameter:
            source: payload
            name: repository.owner.login
      - or:
          - # Trigger on GitHub Issue edits
            and:
              - match:
                  type: value
                  value: issues
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: edited
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: open
                  parameter:
                    source: payload
                    name: issue.state
              - match:
                  type: value
                  value: Renovate Dashboard ðŸ¤–
                  parameter:
                    source: payload
                    name: issue.title
          - # Trigger on GitHub Pull Request edits
            and:
              - match:
                  type: value
                  value: pull_request
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: edited
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: open
                  parameter:
                    source: payload
                    name: pull_request.state
              - match:
                  type: value
                  value: smurf-bot[bot]
                  parameter:
                    source: payload
                    name: pull_request.user.login
          - # Trigger on GitHub Pull Request merge
            and:
              - match:
                  type: value
                  value: pull_request
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: closed
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: true
                  parameter:
                    source: payload
                    name: pull_request.merged
              - match:
                  type: value
                  value: smurf-bot[bot]
                  parameter:
                    source: payload
                    name: pull_request.user.login

- id: github-pr-comments
  execute-command: /config/process-github-event.sh
  pass-arguments-to-command:
    - # Event type
      source: header
      name: x-github-event
    - # Repository
      source: payload
      name: repository.full_name
    - # Comment author
      source: payload
      name: comment.user.login
    - # PR/Issue number
      source: payload
      name: issue.number
    - # Comment body
      source: payload
      name: comment.body
    - # Comment URL
      source: payload
      name: comment.html_url
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger only for the joryirving repo owner
        match:
          type: value
          value: joryirving
          parameter:
            source: payload
            name: repository.owner.login
      - # Trigger on GitHub PR/Issue comments that mention the bot
        match:
          type: value
          value: issue_comment
          parameter:
            source: header
            name: x-github-event
      - # Only trigger when the comment contains a mention of the bot
        match:
          type: regexp
          regex: '@(smurf-bot|github-actions)'
          parameter:
            source: payload
            name: comment.body

- id: github-pr-review-comments
  execute-command: /config/process-github-event.sh
  pass-arguments-to-command:
    - # Event type
      source: header
      name: x-github-event
    - # Repository
      source: payload
      name: repository.full_name
    - # Comment author
      source: payload
      name: comment.user.login
    - # PR number
      source: payload
      name: pull_request.number
    - # Comment body
      source: payload
      name: comment.body
    - # Comment URL
      source: payload
      name: comment.html_url
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger only for the joryirving repo owner
        match:
          type: value
          value: joryirving
          parameter:
            source: payload
            name: repository.owner.login
      - # Trigger on GitHub PR review comments
        match:
          type: value
          value: pull_request_review_comment
          parameter:
            source: header
            name: x-github-event
      - # Only trigger when the comment contains a mention of the bot
        match:
          type: regexp
          regex: '@(smurf-bot|github-actions)'
          parameter:
            source: payload
            name: comment.body

- id: github-pr-reviews
  execute-command: /config/process-github-event.sh
  pass-arguments-to-command:
    - # Event type
      source: header
      name: x-github-event
    - # Repository
      source: payload
      name: repository.full_name
    - # Review author
      source: payload
      name: review.user.login
    - # PR number
      source: payload
      name: pull_request.number
    - # Review body
      source: payload
      name: review.body
    - # Review state
      source: payload
      name: review.state
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger only for the joryirving repo owner
        match:
          type: value
          value: joryirving
          parameter:
            source: payload
            name: repository.owner.login
      - # Trigger on GitHub PR reviews
        match:
          type: value
          value: pull_request_review
          parameter:
            source: header
            name: x-github-event
      - # Only trigger when the review contains a mention of the bot
        match:
          type: regexp
          regex: '@(smurf-bot|github-actions)'
          parameter:
            source: payload
            name: review.body
