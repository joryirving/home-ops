---
- id: github-joryirving-renovate
  execute-command: /config/renovate-operator.sh
  pass-arguments-to-command:
    - # job name
      source: string
      name: joryirving
    - # namespace
      source: string
      name: renovate
    - # project
      source: payload
      name: repository.full_name
    - # Renovate Operator webhook URL
      source: string
      name: http://renovate-operator.renovate.svc.cluster.local:8082
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger only for the joryirving repo owner
        match:
          type: value
          value: joryirving
          parameter:
            source: payload
            name: repository.owner.login
      - or:
          - # Trigger on GitHub Issue edits
            and:
              - match:
                  type: value
                  value: issues
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: edited
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: open
                  parameter:
                    source: payload
                    name: issue.state
              - match:
                  type: value
                  value: Renovate Dashboard ðŸ¤–
                  parameter:
                    source: payload
                    name: issue.title
          - # Trigger on GitHub Pull Request edits
            and:
              - match:
                  type: value
                  value: pull_request
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: edited
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: open
                  parameter:
                    source: payload
                    name: pull_request.state
              - match:
                  type: value
                  value: smurf-bot[bot]
                  parameter:
                    source: payload
                    name: pull_request.user.login
          - # Trigger on GitHub Pull Request merge
            and:
              - match:
                  type: value
                  value: pull_request
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: closed
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: true
                  parameter:
                    source: payload
                    name: pull_request.merged
              - match:
                  type: value
                  value: smurf-bot[bot]
                  parameter:
                    source: payload
                    name: pull_request.user.login

# New hook to handle all PR events and notify OpenClaw
- id: github-pr-notifications
  execute-command: /bin/sh
  command-arguments:
    - -c
    - |
      echo "$(date): Received GitHub PR event: ${X_GITHUB_EVENT} for ${REPOSITORY_NAME}" >&2
      echo "Payload:" >&2
      echo "${HOOK_PAYLOAD}" >&2

      # Extract the relevant data from the payload
      ACTION=$(echo "$HOOK_PAYLOAD" | jq -r '.action // "unknown"')
      REPO_NAME=$(echo "$HOOK_PAYLOAD" | jq -r '.repository.full_name // "unknown"')
      PR_NUMBER=$(echo "$HOOK_PAYLOAD" | jq -r '.pull_request.number // .issue.number // "unknown"')
      EVENT_TYPE=$(echo "$HOOK_PAYLOAD" | jq -r '.action // "unknown"')

      # Prepare JSON payload for OpenClaw
      PAYLOAD_JSON=$(cat <<EOF
      {
        "event": "${X_GITHUB_EVENT}",
        "action": "${ACTION}",
        "repository": "${REPO_NAME}",
        "pr_number": "${PR_NUMBER}",
        "sender": "$(echo "$HOOK_PAYLOAD" | jq -r '.sender.login')",
        "timestamp": "$(date -Iseconds)"
      }
      EOF
      )

      # Send notification to OpenClaw
      curl -s -X POST http://openclaw.llm.svc.cluster.local:3000/webhook/github \
        -H "Content-Type: application/json" \
        -H "X-GitHub-Event: ${X_GITHUB_EVENT}" \
        -H "X-GitHub-Delivery: ${X_GITHUB_DELIVERY}" \
        -d "${PAYLOAD_JSON}"

      if [ $? -eq 0 ]; then
        echo "Successfully sent notification to OpenClaw" >&2
      else
        echo "Failed to send notification to OpenClaw" >&2
      fi
  include-command-output-in-response: true
  pipe-working-directory: /tmp
  pass-environment-to-command:
    - name: HOOK_PAYLOAD
      source: payload
    - name: X_GITHUB_EVENT
      source: header
      name: x-github-event
    - name: X_GITHUB_DELIVERY
      source: header
      name: x-github-delivery
    - name: REPOSITORY_NAME
      source: payload
      name: repository.full_name
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger only for the joryirving repo owner
        match:
          type: value
          value: joryirving
          parameter:
            source: payload
            name: repository.owner.login
      - # Trigger on pull request events (not just for renovate bot)
        match:
          type: value
          value: pull_request
          parameter:
            source: header
            name: x-github-event
