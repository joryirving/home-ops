---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: comfyui-gallery
  namespace: llm
spec:
  chartRef:
    kind: OCIRepository
    name: app-template
  interval: 15m
  values:
    controllers:
      comfyui-gallery:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: nginx
              tag: "1.25.3-alpine"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 50m
              limits:
                memory: 128Mi
    defaultPodOptions:
      securityContext:
        runAsUser: 1000
        runAsGroup: 100
        fsGroup: 100
        fsGroupChangePolicy: "OnRootMismatch"
    service:
      app:
        ports:
          http:
            port: 8080
    route:
      app:
        hostnames: ["comfy-output.jory.dev"]
        parentRefs:
          - name: envoy-external
            namespace: network
    configMaps:
      comfyui-images-nginx:
        data:
          default.conf: |
            server {
                listen 8080;
                server_name _;

                location = / {
                  root /gallery;
                  try_files /index.html =404;
                }

                location ^~ /images/ {
                  alias /images/;
                  autoindex on;
                  autoindex_exact_size off;
                  autoindex_localtime on;

                  expires 30d;
                  add_header Cache-Control "public, immutable, no-store";

                  include /etc/nginx/mime.types;
                  default_type application/octet-stream;
                  index off;
                }

            }
      comfyui-gallery-index:
        data:
          index.html: |
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8" />
              <title>ComfyUI Gallery</title>
              <style>
                body {
                  margin: 0;
                  padding: 1rem;
                  background: #111;
                  color: #eee;
                  font-family: system-ui, sans-serif;
                }
                h1 {
                  margin-bottom: 1rem;
                }
                .grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                  gap: 12px;
                }
                img {
                  width: 100%;
                  height: auto;
                  border-radius: 6px;
                  background: #222;
                }
                a {
                  text-decoration: none;
                  color: inherit;
                }
              </style>
            </head>
            <body>
              <h1>ComfyUI Outputs</h1>
              <div class="grid" id="grid"></div>

              <script>
              fetch("/images/")
                .then(r => r.text())
                .then(html => {
                  const doc = new DOMParser().parseFromString(html, "text/html");
                  const links = [...doc.querySelectorAll("a")]
                    .map(a => a.getAttribute("href"))
                    .filter(h =>
                      h &&
                      !h.endsWith("/") &&
                      h.match(/\.(png|jpg|jpeg|webp)$/i)
                    );

                  const grid = document.getElementById("grid");
                  links.forEach(href => {
                    const a = document.createElement("a");
                    a.href = "/images/" + href;
                    a.target = "_blank";

                    const img = document.createElement("img");
                    img.src = "/images/" + href;

                    a.appendChild(img);
                    grid.appendChild(a);
                  });
                });
              </script>
            </body>
            </html>
    persistence:
      images:
        type: nfs
        server: voyager.internal
        path: /mnt/daena/comfyui/output
        globalMounts:
          - path: /images
            readOnly: true
      nginx-config:
        enabled: true
        type: configMap
        name: "{{ .Release.Name }}-comfyui-images-nginx"
        globalMounts:
          - path: /etc/nginx/conf.d/default.conf
            subPath: default.conf
      gallery-index:
        enabled: true
        type: configMap
        name: "{{ .Release.Name}}-comfyui-gallery-index"
        globalMounts:
          - path: /gallery
            readOnly: true
      nginx-runtime:
        type: emptyDir
        globalMounts:
          - path: /var/cache/nginx
          - path: /var/run
