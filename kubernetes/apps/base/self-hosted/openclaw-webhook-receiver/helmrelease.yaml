---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw-webhook-receiver
  namespace: llm
spec:
  interval: 15m
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      openclaw-webhook-receiver:
        replicas: 1
        strategy: RollingUpdate
        rollingUpdate:
          maxUnavailable: 0
          maxSurge: 1
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: 2026.1.30
            env:
              - name: NODE_ENV
                value: "production"
              - name: PORT
                value: "3000"
              - name: WEBHOOK_SECRET
                valueFrom:
                  secretKeyRef:
                    name: openclaw-webhook-secrets
                    key: webhook-secret
            command:
              - /bin/sh
              - -c
              - |
                echo "Starting OpenClaw webhook receiver..."
                # Simple webhook handler that forwards events to the main OpenClaw instance
                exec /usr/bin/python3 -c "
                import http.server
                import socketserver
                import json
                import urllib.request
                import urllib.parse
                import os
                import sys
                
                class WebhookHandler(http.server.BaseHTTPRequestHandler):
                    def do_POST(self):
                        print(f'Received webhook: {self.path}', file=sys.stderr)
                        
                        content_length = int(self.headers.get('Content-Length', 0))
                        post_data = self.rfile.read(content_length).decode('utf-8')
                        
                        # Get headers
                        headers = {}
                        for key in self.headers.keys():
                            headers[key.lower()] = self.headers[key]
                        
                        print(f'Headers: {headers}', file=sys.stderr)
                        print(f'Payload: {post_data}', file=sys.stderr)
                        
                        # Read the webhook secret from environment or file
                        webhook_secret = os.environ.get('WEBHOOK_SECRET', '')
                        if not webhook_secret:
                            # Try reading from the expected secret file location
                            try:
                                with open('/var/secrets/webhook-secret', 'r') as f:
                                    webhook_secret = f.read().strip()
                            except FileNotFoundError:
                                print('Webhook secret file not found', file=sys.stderr)
                                webhook_secret = ''
                            except Exception as e:
                                print(f'Error reading webhook secret: {str(e)}', file=sys.stderr)
                                webhook_secret = ''
                        
                        # Forward the request to the main OpenClaw instance
                        try:
                            # Construct the request to forward to main OpenClaw
                            req = urllib.request.Request(
                                'http://openclaw.llm.svc.cluster.local:3000/webhook/github',
                                data=post_data.encode('utf-8'),
                                headers={
                                    'Content-Type': 'application/json',
                                    'X-GitHub-Event': headers.get('x-github-event', ''),
                                    'X-GitHub-Delivery': headers.get('x-github-delivery', ''),
                                    'User-Agent': headers.get('user-agent', ''),
                                    'Authorization': f'Bearer {webhook_secret}' if webhook_secret else '',
                                },
                                method='POST'
                            )
                            
                            # Send the request
                            response = urllib.request.urlopen(req)
                            response_data = response.read().decode('utf-8')
                            response_code = response.getcode()
                            
                            print(f'Forwarded to OpenClaw: {response_code}', file=sys.stderr)
                            
                            # Respond to the webhook caller
                            self.send_response(200)
                            self.send_header('Content-Type', 'application/json')
                            self.end_headers()
                            self.wfile.write(json.dumps({
                                'status': 'forwarded',
                                'original_response': response_code
                            }).encode('utf-8'))
                            
                        except Exception as e:
                            print(f'Error forwarding to OpenClaw: {str(e)}', file=sys.stderr)
                            self.send_response(500)
                            self.send_header('Content-Type', 'application/json')
                            self.end_headers()
                            self.wfile.write(json.dumps({
                                'status': 'error',
                                'message': str(e)
                            }).encode('utf-8'))
                
                PORT = 8080
                with socketserver.TCPServer(('', PORT), WebhookHandler) as httpd:
                    print(f'Webhook receiver running on port {PORT}', file=sys.stderr)
                    httpd.serve_forever()
                "
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                memory: 256Mi
    service:
      app:
        ports:
          http:
            port: 8080
    ingress:
      app:
        className: "contour"
        hosts:
          - host: openclaw-webhook.jory.dev
            paths:
              - path: /
                service:
                  identifier: app
                  port: http
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
    persistence:
      webhook-secrets:
        type: secret
        name: openclaw-webhook-secrets
        globalMounts:
          - readOnly: true
            path: /var/secrets/webhook-secret
            subPath: webhook-secret